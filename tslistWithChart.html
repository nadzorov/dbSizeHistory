<HTML>
<HEAD>
	<!-- https://datatables.net/examples/ajax/custom_data_flat.html -->
	<style type="text/css">
		td.details-control {
		    background: url('/img/details_open.png') no-repeat center center;
		    cursor: pointer;
		}
		tr.shown td.details-control {
		    background: url('/img/details_close.png') no-repeat center center;
		}
	</style>
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.11/css/jquery.dataTables.min.css">
	<script src="//code.jquery.com/jquery-1.12.0.min.js"></script>
	<script src="https://cdn.datatables.net/1.10.11/js/jquery.dataTables.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.js"></script>

	<script type="text/javascript">
		// https://datatables.net/examples/api/row_details.html

		function drawChart(canvas, dbname, tsname) {
				
			var jsonData = $.ajax({
    			// url: '/api/chart/dbname/CFTWORK/tsname/T_USR',
    			url: '/api/chart/dbname/' + dbname + '/tsname/' + tsname,
    			dataType: 'json'
  			}).done(function (results) {
  				// data = results;
				var lineChartData = {
					// labels : ["January","February","March","April","May","June","July"],
					labels : results.labels,
					datasets : [
						{
							label: "My First dataset",
							fillColor : "rgba(220,220,220,0.2)",
							strokeColor : "rgba(220,220,220,1)",
							pointColor : "rgba(220,220,220,1)",
							pointStrokeColor : "#fff",
							pointHighlightFill : "#fff",
							pointHighlightStroke : "rgba(220,220,220,1)",
							// CFTWORK T_USR
							// data : [3765,3765,3765,3765,3765,3765,3765,3765,3765,3765,3765,3765,3765,3765,3765,3765,3765,3767]
							data : results.values
						}
						// ,{
						// 	label: "My Second dataset",
						// 	fillColor : "rgba(151,187,205,0.2)",
						// 	strokeColor : "rgba(151,187,205,1)",
						// 	pointColor : "rgba(151,187,205,1)",
						// 	pointStrokeColor : "#fff",
						// 	pointHighlightFill : "#fff",
						// 	pointHighlightStroke : "rgba(151,187,205,1)",
						// 	// CFTWORK I_USR
						// 	data : [2527,2527,2527,2527,2528,2528,2528,2528,2528,2528,2528,2528,2528,2528,2528,2528,2654,2655]
						// }
					]

				}
				var ctx = document.getElementById(canvas).getContext("2d");
				window.myLine = new Chart(ctx).Line(lineChartData, {
					responsive: true
					// ,scaleBeginAtZero : true
					// ,bezierCurve: false
					// ,showScale: false
					// ,scaleShowLabels: false
				});
			});
		}

		/* Formatting function for row details - modify as you need */
		function format ( d ) {
		    // `d` is the original data object for the row
		    return '<div style="width:100%">'+
						'<div>'+
							'<canvas id="canvas' + d.dbname + d.tsname +'" height="100" width="1000"></canvas>'+
						'</div>'+
					'</div>';
		}

		$(document).ready(function() {
		   var table = $('#tslist').DataTable( {
		    	"paging": false,
		    	"info": false,
		    	// disable initioal ordering
		    	// "order": [],
		        "ajax": {
		            // "url": "tslist.json",
		            // "url": "http://127.0.0.1:8080/" + "api" + window.location.pathname,
		            "url": "/api" + window.location.pathname,
		            // same loading speed
		            // "deferRender": true,
		            "dataSrc": ""
		        },
		        
		        "columns": [
		        	 {
		                "className":      'details-control',
		                "orderable":      false,
		                "data":           null,
		                "defaultContent": ''
		            },
		            { "data": "dbname" },
		            { "data": "tsname" },
		            { "data": "gballoc" },
		            { "data": "gbfreeofmax" },
		            { "data": "Date" }
		            // { "data": "position" },
		            // { "data": "office" },
		            // { "data": "extn" },
		            // { "data": "start_date" },
		            // { "data": "salary" }
		        ]
		    } );

		    // Add event listener for opening and closing details
		    $('#showall').on('click', function () {
		        $('#tslist tbody td.details-control').each( function() {
			        var tr = $(this).closest('tr');
			        var row = table.row( tr );
			 
			        if ( row.child.isShown() ) {
			            // This row is already open - close it
			            row.child.hide();
			            tr.removeClass('shown');
			        }
			        else {
			            // Open this row
			            row.child( format(row.data()) ).show();
			            tr.addClass('shown');
			            var canvasName = "canvas" + row.data().dbname + row.data().tsname
			            drawChart(canvasName, row.data().dbname, row.data().tsname);
			        }
			    });
		    } );

		    		    // Add event listener for opening and closing details
		    $('#hideall').on('click', function () {
		        $('#tslist tbody td.details-control').each( function() {
			        var tr = $(this).closest('tr');
			        var row = table.row( tr );
			 
			        if ( row.child.isShown() ) {
			            // This row is already open - close it
			            row.child.hide();
			            tr.removeClass('shown');
			        }
			        else {
			            // Open this row
			            row.child( format(row.data()) ).show();
			            tr.addClass('shown');
			            var canvasName = "canvas" + row.data().dbname + row.data().tsname
			            drawChart(canvasName, row.data().dbname, row.data().tsname);
			        }
			    });
		    } );

		    // Add event listener for opening and closing details
		    $('#tslist tbody').on('click', 'td.details-control', function () {
		        var tr = $(this).closest('tr');
		        var row = table.row( tr );
		 
		        if ( row.child.isShown() ) {
		            // This row is already open - close it
		            row.child.hide();
		            tr.removeClass('shown');
		        }
		        else {
		            // Open this row
		            row.child( format(row.data()) ).show();
		            tr.addClass('shown');
		            var canvasName = "canvas" + row.data().dbname + row.data().tsname
		            drawChart(canvasName, row.data().dbname, row.data().tsname);
		        }
		    } );
		} );
	</script>

</HEAD>
<BODY>
	<p id="showall">Show all</p>
	<p id="hideall">Hide all</p>
	<table id="tslist" class="display compact" cellspacing="0" width="100%">
	<!-- <table id="dblist" class="display compact" cellspacing="0" width="1%"> -->
        <thead>
            <tr>
            	<th></th>
                <th>DB Name</th>
                <th>TS Name</th>
                <th>Allocated GB</th>
                <th>Free of Max GB</th>
                <th>Date</th>
                <!-- <th>Position</th> -->
                <!-- <th>Office</th> -->
                <!-- <th>Extn.</th> -->
                <!-- <th>Start date</th> -->
                <!-- <th>Salary</th> -->
            </tr>
        </thead>
    </table>
</BODY>

</HTML>